<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koha Web Admin Suit</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/theme4.css">
</head>
<body class="light-mode"> <header>
        <div class="brand">
            <i class="fa-solid fa-layer-group"></i> KOHA<span style="font-weight:400; opacity:0.7">OPS</span>
        </div>
        
        <div style="display:flex; align-items:center;">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fa-solid fa-circle-half-stroke"></i>
            </button>

            <div class="conn-bar">
                <input id="host" placeholder="Tailscale IP / Host">
                <input id="user" value="koha" placeholder="User">
                <input type="password" id="pass" placeholder="Sudo Password">
                <button onclick="connectSSH()"><i class="fa-solid fa-plug"></i> Connect</button>
            </div>
        </div>
    </header>

    <div class="layout">
        <nav>
            <button class="active" onclick="tab('dash')"><i class="fa-solid fa-gauge"></i> Dashboard</button>
            <button onclick="tab('tools')"><i class="fa-solid fa-toolbox"></i> Toolbox</button>
            <button onclick="tab('install')"><i class="fa-solid fa-server"></i> Installer</button>
            <button onclick="tab('restore')"><i class="fa-solid fa-clock-rotate-left"></i> Restore</button>
            <button onclick="tab('backup')"><i class="fa-regular fa-hard-drive"></i> Backup</button>
            <button onclick="tab('net')"><i class="fa-solid fa-shield-halved"></i> Network</button>
            <button onclick="tab('sip')"><i class="fa-solid fa-share-nodes"></i> SIP2</button>
            <button onclick="tab('users')"><i class="fa-solid fa-users-gear"></i> Users</button>
            <button class="danger" onclick="tab('danger')"><i class="fa-solid fa-triangle-exclamation"></i> Danger Zone</button>
        </nav>

        <main>
            <div id="dash" class="tab active">
                <div class="dash-header">
                    <h2>Instance Overview</h2>
                    <div class="dash-controls">
                        <button class="btn-tiny" onclick="runTask('health')"><i class="fa-solid fa-rotate"></i> Refresh</button>
                        <button class="btn-tiny" style="color: var(--danger); border-color: var(--danger);" onclick="disconnect()"><i class="fa-solid fa-power-off"></i> Disconnect</button>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="card glass-panel service-card" id="card-koha-common">
                        <div class="svc-top">
                            <div><i class="fa-solid fa-book-open"></i> Koha Core</div>
                            <div class="status-dot" id="dot-koha-common"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('koha-common')">Restart</button>
                    </div>

                    <div class="card glass-panel service-card" id="card-apache2">
                        <div class="svc-top">
                            <div><i class="fa-brands fa-linux"></i> Apache2</div>
                            <div class="status-dot" id="dot-apache2"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('apache2')">Restart</button>
                    </div>

                    <div class="card glass-panel service-card" id="card-mariadb">
                        <div class="svc-top">
                            <div><i class="fa-solid fa-database"></i> MariaDB</div>
                            <div class="status-dot" id="dot-mariadb"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('mariadb')">Restart</button>
                    </div>

                    <div class="card glass-panel service-card" id="card-memcached">
                        <div class="svc-top">
                            <div><i class="fa-solid fa-memory"></i> Memcached</div>
                            <div class="status-dot" id="dot-memcached"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('memcached')">Restart</button>
                    </div>

                    <div class="card glass-panel service-card" id="card-plack">
                        <div class="svc-top">
                            <div><i class="fa-solid fa-bolt"></i> Plack Starman</div>
                            <div class="status-dot" id="dot-plack"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('plack')">Restart All</button>
                    </div>
                    
                    <div class="card glass-panel service-card" id="card-cron">
                        <div class="svc-top">
                            <div><i class="fa-solid fa-clock"></i> Cron Jobs</div>
                            <div class="status-dot" id="dot-cron"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('cron')">Restart</button>
                    </div>
                </div>

                <div class="deep-scan-section glass-panel">
                    <h3><i class="fa-solid fa-magnifying-glass-chart"></i> Deep Inspection</h3>
                    <div class="input-group">
                        <select id="inspect_inst_list">
                            <option>Loading instances...</option>
                        </select>
                        <button class="btn-action" onclick="fetchDeepStats()">Inspect Instance</button>
                    </div>

                    <div id="secrets_panel" class="secrets-grid hidden">
                        <div class="grid-3" style="margin-top:20px;">
                            <div class="info-box">
                                <h4>Credentials</h4>
                                <p><strong>DB Name:</strong> <span class="neon-text" id="d_dbname">...</span></p>
                                <p><strong>DB User:</strong> <span class="neon-text" id="d_dbuser">...</span></p>
                                <p><strong>DB Pass:</strong> <span class="text-danger blur-text" onclick="this.classList.toggle('blur-text')" id="d_dbpass">...</span></p>
                                <p><strong>Version:</strong> <span id="d_ver">...</span></p>
                            </div>

                            <div class="info-box">
                                <h4>Access Points</h4>
                                <a href="#" target="_blank" id="link_staff" class="link-btn">Staff Interface</a>
                                <a href="#" target="_blank" id="link_opac" class="link-btn">OPAC Interface</a>
                            </div>

                            <div class="info-box">
                                <h4>Collection Stats</h4>
                                <div class="stats-row">
                                    <div><small>Items</small><pre id="stat_items">...</pre></div>
                                    <div><small>Patrons</small><pre id="stat_users">...</pre></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tools" class="tab">
                <h2>Maintenance Tools</h2>
                <div class="card glass-panel">
                    <h3>Instance Tasks</h3>
                    <div class="input-group">
                        <input id="tool_inst" placeholder="Target Instance (e.g. library)">
                        <button class="btn-action" onclick="runTask('toolbox', {action: 'zebra', inst: val('tool_inst')})">Rebuild Zebra</button>
                        <button class="btn-action" onclick="runTask('toolbox', {action: 'perms', inst: val('tool_inst')})">Fix Permissions</button>
                    </div>
                </div>
                
                <div class="card glass-panel">
                    <h3>SQL Runner</h3>
                    <textarea id="sql_query" rows="5" placeholder="SELECT * FROM items WHERE..."></textarea>
                    <button class="btn-action full-width" onclick="runTask('sql', {inst: val('tool_inst'), query: val('sql_query')})">Execute Query</button>
                </div>
            </div>

            <div id="install" class="tab">
                <h2>New Installation</h2>
                <div class="card glass-panel">
                    <p>Deploy a new Koha instance with automatic configuration.</p>
                    <div class="grid-2">
                        <div>
                            <label>Koha Version</label>
                            <input id="i_ver" placeholder="e.g. 24.05">
                        </div>
                        <div>
                            <label>Instance Name</label>
                            <input id="i_name" placeholder="e.g. mainlibrary">
                        </div>
                        <div>
                            <label>Staff Port</label>
                            <input id="i_sport" placeholder="e.g. 8080">
                        </div>
                        <div>
                            <label>OPAC Port</label>
                            <input id="i_oport" placeholder="e.g. 8081">
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0; display: flex; gap: 20px;">
                        <label><input type="checkbox" id="i_plack" checked> Enable Plack (High Performance)</label>
                        <label><input type="checkbox" id="i_fix" checked> Auto-Fix Configuration Files</label>
                    </div>
                    
                    <button class="btn-action full-width" onclick="installKoha()">Deploy Instance</button>
                </div>
            </div>

            <div id="restore" class="tab">
                <h2>Database Restore</h2>
                <div class="card glass-panel">
                    <div class="grid-2">
                        <div>
                            <label>Target Instance</label>
                            <input id="r_inst" placeholder="e.g. library">
                        </div>
                        <div>
                            <label>SQL File</label>
                            <input type="file" id="r_file" style="padding: 7px;">
                        </div>
                    </div>
                    <label style="display:block; margin: 15px 0;">
                        <input type="checkbox" id="r_zebra" checked> Rebuild Zebra & Restart Plack after restore
                    </label>
                    <button class="btn-warn full-width" onclick="uploadRestore()">Upload & Restore Database</button>
                </div>
            </div>

            <div id="backup" class="tab">
                <h2>Backup Center</h2>
                
                <div class="card glass-panel" style="border-left: 4px solid var(--success);">
                    <h3><i class="fa-solid fa-bolt"></i> Manual Backup</h3>
                    <p>Trigger an immediate full database backup for all instances.</p>
                    <button class="btn-action" onclick="runTask('backup_now')">Run Immediate Backup</button>
                </div>

                <div class="card glass-panel">
                    <h3><i class="fa-solid fa-calendar-days"></i> Automated Schedule</h3>
                    <p class="text-muted">Configure daily offsite backups (Defaults to 5:00 PM).</p>

                    <div class="inner-dark">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <input type="checkbox" id="b_gdrive" onchange="toggleGdrive()" style="width: auto;">
                            <label for="b_gdrive" style="cursor: pointer; font-weight:bold;">Enable Cloud Sync (Rclone)</label>
                        </div>
                        
                        <div class="grid-2">
                            <input id="b_remote" placeholder="Remote Name (e.g. gdrive)" disabled>
                            <input id="b_path" placeholder="Remote Path (e.g. /koha-backups)" disabled>
                        </div>
                    </div>

                    <button class="btn-warn full-width" onclick="configureBackup()">Save Configuration</button>
                </div>
            </div>

            <div id="net" class="tab">
                <h2>Network Security</h2>
                
                <div class="card glass-panel">
                    <h3><i class="fa-solid fa-shield-cat"></i> Firewall (UFW)</h3>
                    <div style="margin-bottom: 15px;">
                        <label>Global Open Ports</label>
                        <input id="u_ports" placeholder="80, 443, 8080">
                        <small class="text-muted">Ports accessible to the entire internet.</small>
                    </div>
                    
                    <div class="grid-2">
                        <div>
                            <label>Restricted Ports</label>
                            <input id="u_rports" placeholder="8051, 22">
                        </div>
                        <div>
                            <label>Allowed IPs</label>
                            <input id="u_rips" placeholder="192.168.1.50">
                        </div>
                    </div>
                    
                    <button class="btn-action full-width" onclick="runTask('ufw', {ports: val('u_ports'), rports: val('u_rports'), rips: val('u_rips')})">
                        Apply Rules
                    </button>
                </div>

                <div class="card glass-panel">
                    <h3><i class="fa-solid fa-lock"></i> Stunnel Generator</h3>
                    
                    <div class="inner-dark">
                        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                            <label><input type="checkbox" id="s_psk"> Use Pre-Shared Key (PSK)</label>
                        </div>
                        
                        <div style="display: flex; gap: 20px; margin-bottom: 15px; align-items: center;">
                            <span style="opacity:0.7">Client IP:</span>
                            <label><input type="radio" name="ip_mode" value="auto" checked onchange="toggleIP(this)"> Auto</label>
                            <label><input type="radio" name="ip_mode" value="manual" onchange="toggleIP(this)"> Manual</label>
                        </div>

                        <div class="grid-2">
                             <input id="s_name" placeholder="Certificate Name (e.g. library_secure)">
                             <input id="s_manual_ip" placeholder="Server IP (e.g. 100.x.x.x)" disabled>
                        </div>
                    </div>

                    <button class="btn-warn full-width" onclick="genStunnel()">Generate Configuration</button>
                </div>
            </div>

            <div id="sip" class="tab">
                <h2>SIP2 Configuration</h2>
                <div class="card glass-panel">
                    <div class="grid-2">
                        <div>
                            <label>Instance</label>
                            <input id="sip_inst" placeholder="library">
                        </div>
                        <div>
                            <label>Institution ID</label>
                            <input id="sip_iid" value="MAIN">
                        </div>
                        <div>
                            <label>SIP User</label>
                            <input id="sip_user" placeholder="sip_user">
                        </div>
                        <div>
                            <label>SIP Password</label>
                            <input id="sip_pass" placeholder="SecretPass">
                        </div>
                        <div>
                            <label>Telnet Port</label>
                            <input id="sip_telnet" value="8023">
                        </div>
                        <div>
                            <label>Raw Port</label>
                            <input id="sip_raw" value="6001">
                        </div>
                    </div>
                    <button class="btn-action full-width" onclick="configureSIP()">Enable SIP2 Service</button>
                </div>
            </div>

            <div id="users" class="tab">
                <h2>User Management</h2>
                
                <div class="card glass-panel">
                    <h3>Create Superlibrarian</h3>
                    <div class="input-group">
                        <input id="u_inst" placeholder="Instance Name">
                        <button class="btn-action" onclick="fetchUserData()" style="width: auto;">Fetch Branches</button>
                    </div>
                    
                    <div class="grid-2">
                        <input id="u_card" placeholder="Cardnumber">
                        <input id="u_name" placeholder="Username">
                        <input id="u_pass" placeholder="Password">
                        <select id="u_branch"><option value="">Select Branch...</option></select>
                        <select id="u_cat"><option value="">Select Category...</option></select>
                    </div>
                    
                    <button class="btn-action full-width" onclick="createSuper()">Create Admin User</button>
                </div>

                <div class="card glass-panel">
                    <h3>MySQL User Management</h3>
                    <div class="grid-2">
                        <input id="db_name" placeholder="DB Name">
                        <input id="db_host" value="%" placeholder="Host (%)">
                        <input id="db_user" placeholder="New DB User">
                        <input id="db_pass" placeholder="New DB Password">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display:block; margin-bottom: 5px; font-size:0.85rem">SQL Object File (Optional):</label>
                        <input type="file" id="db_file">
                    </div>

                    <button class="btn-warn full-width" onclick="createDBUser()">Create User & Import SQL</button>
                </div>
            </div>

            <div id="danger" class="tab">
                <h2 style="color: var(--danger)">Danger Zone</h2>
                <p>Destructive actions. These cannot be undone.</p>

                <div class="card glass-panel" style="border-left: 4px solid var(--danger);">
                    <h3>Delete Instance</h3>
                    <p>Permanently remove a Koha instance and its database.</p>
                    <div class="input-group">
                        <input id="rm_inst_name" placeholder="Instance Name to Delete">
                        <button class="btn-danger" onclick="rmInstance()">Delete Instance</button>
                    </div>
                </div>

                <div class="card glass-panel" style="border-color: var(--danger);">
                    <h3>System Nukes</h3>
                    
                    <div class="grid-3">
                         <button class="btn-danger full-width" onclick="nukeStunnel()">Remove Stunnel</button>
                         <button class="btn-danger full-width" onclick="nukeTailscale()">Remove Tailscale</button>
                         <button class="btn-danger full-width" onclick="nukeKoha()">Uninstall Koha</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="resizer" title="Drag to resize"></div> 

    <div id="console">
        <div style="color: #64748b; margin-bottom: 10px;">// TERMINAL OUTPUT -------------------</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        // Utils
        const val = (id) => document.getElementById(id).value;
        const isChk = (id) => document.getElementById(id).checked;
        const tab = (id) => {
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(e => e.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            
            // Find the button that corresponds to this tab and make it active
            document.querySelectorAll('nav button').forEach(btn => {
                if(btn.getAttribute('onclick').includes(id)) {
                    btn.classList.add('active');
                }
            });
        };

        // Socket Logic
        socket.on('log_update', (d) => {
            const c = document.getElementById('console');
            c.innerHTML += `<div class="${d.type}">> ${d.msg}</div>`;
            c.scrollTop = c.scrollHeight;
        });

        // Actions
        function connectSSH() {
            socket.emit('connect_ssh', {host: val('host'), user: val('user'), pass: val('pass')});
        }

        function runTask(name, args={}) {
            socket.emit('task', {name: name, args: args});
        }

        function installKoha() {
            runTask('install', {
                ver: val('i_ver'), name: val('i_name'), 
                sport: val('i_sport'), oport: val('i_oport'), 
                plack: isChk('i_plack'), fix: isChk('i_fix')
            });
        }

        function uploadRestore() {
            const fileInput = document.getElementById('r_file');
            if(fileInput.files.length === 0) {
                alert("Please select a file!"); 
                return;
            }

            const fd = new FormData();
            fd.append('file', fileInput.files[0]);
            fd.append('inst', val('r_inst'));
            fd.append('type', 'restore');
            // FIX: Send the checkbox state
            fd.append('zebra', document.getElementById('r_zebra').checked);
            
            // UI Feedback
            const btn = document.querySelector('#restore button');
            const originalText = btn.innerText;
            btn.innerText = "⏳ UPLOADING...";
            btn.disabled = true;

            fetch('/upload-db', {method: 'POST', body: fd})
            .then(r => r.json())
            .then(d => {
                alert("Upload complete. Restore started in background.");
                btn.innerText = originalText;
                btn.disabled = false;
            })
            .catch(e => {
                alert("Upload failed: " + e);
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }
        // Backup Config
        function toggleGdrive() {
            const on = document.getElementById('b_gdrive').checked;
            const remoteInput = document.getElementById('b_remote');
            const pathInput = document.getElementById('b_path');
            
            remoteInput.disabled = !on;
            pathInput.disabled = !on;
            
            // Visual feedback
            if(on) {
                remoteInput.style.opacity = "1";
                pathInput.style.opacity = "1";
            } else {
                remoteInput.style.opacity = "0.5";
                pathInput.style.opacity = "0.5";
            }
        }

        function configureBackup() {
            runTask('backup_config', {
                gdrive: document.getElementById('b_gdrive').checked,
                remote: document.getElementById('b_remote').value,
                path: document.getElementById('b_path').value
            });
        }

        //Stunnel
        // New Listener for File Downloads
        socket.on('download_ready', (d) => {
            // Trigger browser download
            window.location.href = `/download/${d.filename}`;
        });

        // Stunnel UI Logic
        function toggleIP(radio) {
            const input = document.getElementById('s_manual_ip');
            if (radio.value === 'manual') {
                input.disabled = false;
                input.style.opacity = "1";
            } else {
                input.disabled = true;
                input.style.opacity = "0.5";
            }
        }

        function genStunnel() {
            const isAuto = document.querySelector('input[name="ip_mode"]:checked').value === 'auto';
            runTask('stunnel', {
                name: val('s_name'),
                psk: isChk('s_psk'),
                auto: isAuto,
                man: val('s_manual_ip')
            });
        }

        // SIP2 Config
        function configureSIP() {
            runTask('sip2', {
                inst: val('sip_inst'),
                user: val('sip_user'),
                pass: val('sip_pass'),
                telnet: val('sip_telnet'),
                raw: val('sip_raw'),
                iid: val('sip_iid')
            });
        }

        // --- USERS SECTION ---
        
        // 1. Fetch Branches & Categories
        function fetchUserData() {
            const inst = val('u_inst');
            if(!inst) { alert("Enter instance name!"); return; }
            const btn = document.querySelector('#users button');
            const txt = btn.innerText;
            btn.innerText = "⏳ FETCHING...";
            runTask('fetch_user_data', {inst: inst});
            setTimeout(() => btn.innerText = txt, 2000);
        }

        // Listener for Data Return
        socket.on('user_data_ready', (d) => {
            const br = document.getElementById('u_branch');
            const cat = document.getElementById('u_cat');
            
            br.innerHTML = ''; 
            cat.innerHTML = '';
            
            d.branches.forEach(b => {
                let opt = document.createElement('option');
                opt.value = b.code;
                opt.innerText = b.name;
                br.appendChild(opt);
            });

            d.categories.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c.code;
                opt.innerText = c.name;
                // Auto-select "Superlibrarian" if found
                if(c.name.includes("Super") || c.code.includes("S")) opt.selected = true;
                cat.appendChild(opt);
            });
            alert(`Loaded ${d.branches.length} branches and ${d.categories.length} categories.`);
        });

        // 2. Create Superlibrarian
        function createSuper() {
            runTask('create_super', {
                inst: val('u_inst'),
                card: val('u_card'),
                user: val('u_name'),
                pass: val('u_pass'),
                branch: val('u_branch'),
                category: val('u_cat')
            });
        }

        // 3. Create MySQL User & Upload
        function createDBUser() {
            const fd = new FormData();
            fd.append('type', 'db_user');
            fd.append('dbname', val('db_name'));
            fd.append('host', val('db_host'));
            fd.append('dbuser', val('db_user'));
            fd.append('dbpass', val('db_pass'));
            
            // Optional File
            const f = document.getElementById('db_file');
            if(f.files.length > 0) fd.append('file', f.files[0]);

            const btn = document.querySelector('#users .btn-warn');
            const txt = btn.innerText;
            btn.innerText = "⏳ PROCESSING...";
            btn.disabled = true;

            fetch('/upload-sp', {method: 'POST', body: fd})
            .then(r => r.json())
            .then(d => {
                alert("Task Started. Check logs.");
                btn.innerText = txt;
                btn.disabled = false;
            })
            .catch(e => {
                alert("Error: " + e);
                btn.innerText = txt;
                btn.disabled = false;
            });
        }

        // --- DANGER ZONE ---
        
        function rmInstance() {
            const inst = val('rm_inst_name');
            if (!inst) { alert("Enter instance name!"); return; }
            if (confirm(`Are you sure you want to delete '${inst}'?\nThis cannot be undone.`)) {
                runTask('rm_inst', {inst: inst});
            }
        }

        function nukeStunnel() {
            if (confirm("Uninstall Stunnel completely?\nRemoves service, configs, and users.")) {
                runTask('rm_stunnel');
            }
        }

        function nukeTailscale() {
            if (confirm("NUKE TAILSCALE?\nYou will lose connection immediately.")) {
                runTask('rm_tailscale');
            }
        }

        function nukeKoha() {
            if (confirm("WARNING: UNINSTALL KOHA COMPLETELY?\nThis will remove ALL instances, databases, and users.")) {
                if (confirm("FINAL WARNING: This is irreversible.\nAre you really sure?")) {
                    runTask('rm_koha');
                }
            }
        }
    </script>
    <script src="/static/script.js"></script>
</body>
</html>