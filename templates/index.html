<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Koha Admin Ultimate // v8.0</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="overlay"></div>

    <header>
        <div class="brand"><i class="fa-solid fa-terminal"></i> KOHA OPS</div>
        <div class="conn-bar">
            <input id="host" placeholder="Tailscale IP">
            <input id="user" value="koha">
            <input type="password" id="pass" placeholder="Sudo Pass">
            <button onclick="connectSSH()"><i class="fa-solid fa-bolt"></i> CONNECT</button>
        </div>
    </header>

    <div class="layout">
        <nav>
            <button class="active" onclick="tab('dash')"><i class="fa-solid fa-chart-pie"></i> Dashboard</button>
            <button onclick="tab('tools')"><i class="fa-solid fa-wrench"></i> Toolbox</button>
            <button onclick="tab('install')"><i class="fa-solid fa-download"></i> Installer</button>
            <button onclick="tab('restore')"><i class="fa-solid fa-rotate-left"></i> Restore</button>
            <button onclick="tab('backup')"><i class="fa-solid fa-floppy-disk"></i> Backup</button>
            <button onclick="tab('net')"><i class="fa-solid fa-network-wired"></i> Network</button>
            <button onclick="tab('sip')"><i class="fa-solid fa-share-nodes"></i> SIP2</button>
            <button onclick="tab('users')"><i class="fa-solid fa-users"></i> Users</button>
            <button class="danger" onclick="tab('danger')"><i class="fa-solid fa-skull"></i> Danger</button>
        </nav>

        <main>
            <div id="dash" class="tab active">
                <div class="dash-header">
                    <h2><i class="fa-solid fa-gauge-high"></i> Command Center</h2>
                    <div class="dash-controls">
                        <button class="btn-action" onclick="runTask('health')"><i class="fa-solid fa-rotate"></i> REFRESH</button>
                        <button class="btn-danger" onclick="disconnect()"><i class="fa-solid fa-power-off"></i> DISCONNECT</button>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="card service-card" id="card-koha-common">
                        <div class="svc-top">
                            <i class="fa-solid fa-server"></i> <span>Koha Core</span>
                            <div class="status-dot" id="dot-koha-common"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('koha-common')">Restart</button>
                    </div>

                    <div class="card service-card" id="card-apache2">
                        <div class="svc-top">
                            <i class="fa-brands fa-linux"></i> <span>Apache2</span>
                            <div class="status-dot" id="dot-apache2"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('apache2')">Restart</button>
                    </div>

                    <div class="card service-card" id="card-mariadb">
                        <div class="svc-top">
                            <i class="fa-solid fa-database"></i> <span>MariaDB</span>
                            <div class="status-dot" id="dot-mariadb"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('mariadb')">Restart</button>
                    </div>

                    <div class="card service-card" id="card-memcached">
                        <div class="svc-top">
                            <i class="fa-solid fa-memory"></i> <span>Memcached</span>
                            <div class="status-dot" id="dot-memcached"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('memcached')">Restart</button>
                    </div>

                    <div class="card service-card" id="card-plack">
                        <div class="svc-top">
                            <i class="fa-solid fa-bolt"></i> <span>Plack (Starman)</span>
                            <div class="status-dot" id="dot-plack"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('plack')">Restart All</button>
                    </div>
                    
                    <div class="card service-card" id="card-cron">
                        <div class="svc-top">
                            <i class="fa-solid fa-clock"></i> <span>Cron Jobs</span>
                            <div class="status-dot" id="dot-cron"></div>
                        </div>
                        <button class="btn-tiny" onclick="restartSvc('cron')">Restart</button>
                    </div>
                </div>

                <hr class="glow-sep">

                <div class="deep-scan-section">
                    <h3><i class="fa-solid fa-microscope"></i> Deep Instance Inspection</h3>
                    <div class="input-group">
                        <select id="inspect_inst_list">
                            <option>Loading instances...</option>
                        </select>
                        <button onclick="fetchDeepStats()">üîç FETCH SECRETS & STATS</button>
                    </div>

                    <div id="secrets_panel" class="secrets-grid hidden">
                        <div class="card info-box">
                            <h4><i class="fa-solid fa-key"></i> Credentials</h4>
                            <p><strong>DB Name:</strong> <span class="neon-text" id="d_dbname">...</span></p>
                            <p><strong>DB User:</strong> <span class="neon-text" id="d_dbuser">...</span></p>
                            <p><strong>DB Pass:</strong> <span class="text-danger blur-text" onclick="this.classList.toggle('blur-text')" id="d_dbpass">...</span> (Click to reveal)</p>
                            <p><strong>Koha Ver:</strong> <span id="d_ver">...</span></p>
                        </div>

                        <div class="card info-box">
                            <h4><i class="fa-solid fa-link"></i> Access Points</h4>
                            <p><a href="#" target="_blank" id="link_staff" class="link-btn">üöÄ Staff Interface</a></p>
                            <p><a href="#" target="_blank" id="link_opac" class="link-btn">üìö OPAC Interface</a></p>
                        </div>

                        <div class="card info-box wide">
                            <h4><i class="fa-solid fa-chart-pie"></i> Collection Stats</h4>
                            <div class="stats-row">
                                <div><h5>Items (Type)</h5><pre id="stat_items">Loading...</pre></div>
                                <div><h5>Patrons (Cat)</h5><pre id="stat_users">Loading...</pre></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tools" class="tab">
                <h2>Maintenance Tools</h2>
                <div class="input-group">
                    <input id="tool_inst" placeholder="Target Instance">
                    <button onclick="runTask('toolbox', {action: 'zebra', inst: val('tool_inst')})">Rebuild Zebra</button>
                    <button onclick="runTask('toolbox', {action: 'perms', inst: val('tool_inst')})">Fix Perms</button>
                </div>
                <hr>
                <h2>SQL Runner</h2>
                <textarea id="sql_query" rows="3" placeholder="SELECT * FROM..."></textarea>
                <button onclick="runTask('sql', {inst: val('tool_inst'), query: val('sql_query')})">Run SQL</button>
            </div>

            <div id="install" class="tab">
                <h2>New Installation</h2>
                <div class="grid-2">
                    <input id="i_ver" placeholder="Version (24.05)">
                    <input id="i_name" placeholder="Name (library)">
                    <input id="i_sport" placeholder="Staff Port (8080)">
                    <input id="i_oport" placeholder="OPAC Port (8081)">
                </div>
                <label><input type="checkbox" id="i_plack" checked> Enable Plack</label>
                <label><input type="checkbox" id="i_fix" checked> Auto-Fix Config</label>
                <button class="btn-action" onclick="installKoha()">üöÄ DEPLOY INSTANCE</button>
            </div>

            <div id="restore" class="tab">
                <h2>Database Restore</h2>
                <input id="r_inst" placeholder="Target Instance">
                <input type="file" id="r_file">
                <br>
                <label style="display:block; margin: 10px 0;">
                    <input type="checkbox" id="r_zebra" checked> Rebuild Zebra & Restart Plack
                </label>
                <button class="btn-warn" onclick="uploadRestore()">‚ö†Ô∏è UPLOAD & RESTORE</button>
            </div>

            <div id="backup" class="tab">
                <h2><i class="fa-solid fa-floppy-disk"></i> Backup Center</h2>
                
                <div class="card" style="border-left: 4px solid #00ff00; margin-bottom: 20px;">
                    <h3>‚ö° Immediate Action</h3>
                    <p>Run a full database backup for all instances right now.</p>
                    <button class="btn-action full-width" onclick="runTask('backup_now')">
                        üíæ RUN IMMEDIATE DB BACKUP
                    </button>
                </div>

                <hr>

                <h3><i class="fa-solid fa-clock"></i> Automated Schedule (Cron)</h3>
                <p class="text-muted">Configures daily local backups at 5:00 PM.</p>

                <div style="background: #222; padding: 15px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #444;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <input type="checkbox" id="b_gdrive" onchange="toggleGdrive()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="b_gdrive" style="color: white; font-weight: bold; cursor: pointer;">Enable Google Drive Sync (Extends Local Backup)</label>
                    </div>
                    
                    <div class="grid-2">
                        <input id="b_remote" placeholder="Rclone Remote Name (e.g. gdrive)" disabled>
                        <input id="b_path" placeholder="Drive Path (e.g. /backups)" disabled>
                    </div>
                </div>

                <button class="btn-warn full-width" onclick="configureBackup()">‚öôÔ∏è APPLY BACKUP CONFIGURATION</button>
            </div>

            <div id="net" class="tab">
                <h2><i class="fa-solid fa-network-wired"></i> Network Security</h2>
                
                <div class="card" style="margin-bottom: 20px;">
                    <h3>üõ°Ô∏è Firewall (UFW)</h3>
                    <label>Global Open Ports (e.g. 80, 8080, 443):</label>
                    <input id="u_ports" placeholder="80, 443">
                    
                    <div class="grid-2" style="margin-top: 10px;">
                        <div>
                            <label>Restricted Ports (e.g. 8051, 8052, 8053, 22):</label>
                            <input id="u_rports" placeholder="8051">
                        </div>
                        <div>
                            <label>Allowed IPs (Comma separated):</label>
                            <input id="u_rips" placeholder="192.168.1.50, 10.0.0.5">
                        </div>
                    </div>
                    
                    <button class="btn-action full-width" style="margin-top: 15px;" 
                            onclick="runTask('ufw', {ports: val('u_ports'), rports: val('u_rports'), rips: val('u_rips')})">
                        üõ°Ô∏è APPLY FIREWALL RULES
                    </button>
                </div>

                <hr>

                <div class="card">
                    <h3>üîí Stunnel Generator</h3>
                    <p class="text-muted">Generates a Windows-ready ZIP with Stunnel config + Keys.</p>
                    
                    <div style="background: #222; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                            <label style="color: white; cursor: pointer;">
                                <input type="checkbox" id="s_psk"> Use PSK (Pre-Shared Key)
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                            <label style="color: #ccc;">Client Connect IP:</label>
                            <label style="color: white; cursor: pointer;">
                                <input type="radio" name="ip_mode" value="auto" checked onchange="toggleIP(this)"> Auto-Detect
                            </label>
                            <label style="color: white; cursor: pointer;">
                                <input type="radio" name="ip_mode" value="manual" onchange="toggleIP(this)"> Manual
                            </label>
                        </div>

                        <input id="s_name" placeholder="Certificate Name (e.g. library_secure)" style="margin-bottom: 10px;">
                        <input id="s_manual_ip" placeholder="Manual Server IP (e.g. 100.x.x.x)" disabled style="opacity: 0.5;">
                    </div>

                    <button class="btn-warn full-width" onclick="genStunnel()">üì¶ GENERATE & DOWNLOAD CONFIG</button>
                </div>
            </div>

            <div id="sip" class="tab">
                <h2><i class="fa-solid fa-share-nodes"></i> SIP2 Configuration</h2>
                <div class="card">
                    <div class="grid-2">
                        <div>
                            <label>Target Instance:</label>
                            <input id="sip_inst" placeholder="library">
                        </div>
                        <div>
                            <label>Institution ID (e.g. MAIN):</label>
                            <input id="sip_iid" value="MAIN">
                        </div>
                        <div>
                            <label>SIP2 Login (User):</label>
                            <input id="sip_user" placeholder="sip_user">
                        </div>
                        <div>
                            <label>SIP2 Password:</label>
                            <input id="sip_pass" placeholder="SecretPass">
                        </div>
                        <div>
                            <label>Telnet Port (Standard: 8023):</label>
                            <input id="sip_telnet" value="8023">
                        </div>
                        <div>
                            <label>Raw Port (Standard: 6001):</label>
                            <input id="sip_raw" value="6001">
                        </div>
                    </div>
                    <button class="btn-action full-width" style="margin-top: 20px;" onclick="configureSIP()">
                        ‚öôÔ∏è ENABLE & CONFIGURE SIP2
                    </button>
                </div>
            </div>

            <div id="users" class="tab">
                <h2><i class="fa-solid fa-user-shield"></i> User Management</h2>
                
                <div class="card" style="margin-bottom: 20px;">
                    <h3>ü¶∏ Create Superlibrarian</h3>
                    <div class="input-group">
                        <input id="u_inst" placeholder="Instance Name">
                        <button onclick="fetchUserData()" style="width: auto;">üîç Fetch Data</button>
                    </div>
                    
                    <div class="grid-2">
                        <input id="u_card" placeholder="Cardnumber">
                        <input id="u_name" placeholder="Username">
                        <input id="u_pass" placeholder="Password">
                        <select id="u_branch"><option value="">Select Branch (Fetch First)</option></select>
                        <select id="u_cat"><option value="">Select Category (Fetch First)</option></select>
                    </div>
                    
                    <button class="btn-action full-width" style="margin-top: 15px;" onclick="createSuper()">
                        üöÄ CREATE ADMIN USER
                    </button>
                </div>

                <hr>

                <div class="card">
                    <h3>üóÑÔ∏è MySQL User & Objects</h3>
                    <div class="grid-2">
                        <input id="db_name" placeholder="DB Name (koha_library)">
                        <input id="db_host" value="%" placeholder="Bind Host (% or IP)">
                        <input id="db_user" placeholder="New DB User">
                        <input id="db_pass" placeholder="New DB Password">
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px; margin: 15px 0;">
                        <label style="color: #aaa; font-size: 0.9em; display:block; margin-bottom: 5px;">SQL Object File (Optional):</label>
                        <input type="file" id="db_file" style="color: white; width: 100%;">
                    </div>

                    <button class="btn-warn full-width" onclick="createDBUser()">
                        üõ†Ô∏è CREATE USER & IMPORT SQL
                    </button>
                </div>
            </div>

            <div id="danger" class="tab">
                <h2 class="text-danger"><i class="fa-solid fa-triangle-exclamation"></i> Danger Zone</h2>
                <p class="text-muted">Destructive actions. Proceed with caution.</p>

                <div class="card" style="border-left: 4px solid #ff4444; margin-bottom: 20px;">
                    <h3>Remove Specific Instance</h3>
                    <div class="input-group">
                        <input id="rm_inst_name" placeholder="Instance Name (e.g. library)">
                        <button class="btn-danger" onclick="rmInstance()">üóëÔ∏è DELETE INSTANCE</button>
                    </div>
                </div>

                <hr style="border-color: #555;">

                <div class="card" style="border: 1px solid #ff0000;">
                    <h3>üî• System Cleanup</h3>
                    
                    <button class="btn-danger full-width" style="margin-bottom: 10px;" onclick="nukeStunnel()">
                        ‚ùå UNINSTALL STUNNEL COMPLETELY
                    </button>

                    <button class="btn-danger full-width" style="margin-bottom: 10px;" onclick="nukeTailscale()">
                        ‚ò¢Ô∏è NUKE TAILSCALE (SELF DESTRUCT)
                    </button>

                    <button class="btn-danger full-width" onclick="nukeKoha()">
                        üî• UNINSTALL KOHA COMPLETELY (ALL DATA LOST)
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="console"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        // Utils
        const val = (id) => document.getElementById(id).value;
        const isChk = (id) => document.getElementById(id).checked;
        const tab = (id) => {
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // Socket Logic
        socket.on('log_update', (d) => {
            const c = document.getElementById('console');
            c.innerHTML += `<div class="${d.type}">> ${d.msg}</div>`;
            c.scrollTop = c.scrollHeight;
        });

        // Actions
        function connectSSH() {
            socket.emit('connect_ssh', {host: val('host'), user: val('user'), pass: val('pass')});
        }

        function runTask(name, args={}) {
            socket.emit('task', {name: name, args: args});
        }

        function installKoha() {
            runTask('install', {
                ver: val('i_ver'), name: val('i_name'), 
                sport: val('i_sport'), oport: val('i_oport'), 
                plack: isChk('i_plack'), fix: isChk('i_fix')
            });
        }

        function uploadRestore() {
            const fileInput = document.getElementById('r_file');
            if(fileInput.files.length === 0) {
                alert("Please select a file!"); 
                return;
            }

            const fd = new FormData();
            fd.append('file', fileInput.files[0]);
            fd.append('inst', val('r_inst'));
            fd.append('type', 'restore');
            // FIX: Send the checkbox state
            fd.append('zebra', document.getElementById('r_zebra').checked);
            
            // UI Feedback
            const btn = document.querySelector('#restore button');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ UPLOADING...";
            btn.disabled = true;

            fetch('/upload-db', {method: 'POST', body: fd})
            .then(r => r.json())
            .then(d => {
                alert("Upload complete. Restore started in background.");
                btn.innerText = originalText;
                btn.disabled = false;
            })
            .catch(e => {
                alert("Upload failed: " + e);
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }
        // Backup Config
        function toggleGdrive() {
            const on = document.getElementById('b_gdrive').checked;
            const remoteInput = document.getElementById('b_remote');
            const pathInput = document.getElementById('b_path');
            
            remoteInput.disabled = !on;
            pathInput.disabled = !on;
            
            // Visual feedback
            if(on) {
                remoteInput.style.opacity = "1";
                pathInput.style.opacity = "1";
            } else {
                remoteInput.style.opacity = "0.5";
                pathInput.style.opacity = "0.5";
            }
        }

        function configureBackup() {
            runTask('backup_config', {
                gdrive: document.getElementById('b_gdrive').checked,
                remote: document.getElementById('b_remote').value,
                path: document.getElementById('b_path').value
            });
        }

        //Stunnel
        // New Listener for File Downloads
        socket.on('download_ready', (d) => {
            // Trigger browser download
            window.location.href = `/download/${d.filename}`;
        });

        // Stunnel UI Logic
        function toggleIP(radio) {
            const input = document.getElementById('s_manual_ip');
            if (radio.value === 'manual') {
                input.disabled = false;
                input.style.opacity = "1";
            } else {
                input.disabled = true;
                input.style.opacity = "0.5";
            }
        }

        function genStunnel() {
            const isAuto = document.querySelector('input[name="ip_mode"]:checked').value === 'auto';
            runTask('stunnel', {
                name: val('s_name'),
                psk: isChk('s_psk'),
                auto: isAuto,
                man: val('s_manual_ip')
            });
        }

        // SIP2 Config
        function configureSIP() {
            runTask('sip2', {
                inst: val('sip_inst'),
                user: val('sip_user'),
                pass: val('sip_pass'),
                telnet: val('sip_telnet'),
                raw: val('sip_raw'),
                iid: val('sip_iid')
            });
        }

        // --- USERS SECTION ---
        
        // 1. Fetch Branches & Categories
        function fetchUserData() {
            const inst = val('u_inst');
            if(!inst) { alert("Enter instance name!"); return; }
            const btn = document.querySelector('#users button');
            const txt = btn.innerText;
            btn.innerText = "‚è≥ FETCHING...";
            runTask('fetch_user_data', {inst: inst});
            setTimeout(() => btn.innerText = txt, 2000);
        }

        // Listener for Data Return
        socket.on('user_data_ready', (d) => {
            const br = document.getElementById('u_branch');
            const cat = document.getElementById('u_cat');
            
            br.innerHTML = ''; 
            cat.innerHTML = '';
            
            d.branches.forEach(b => {
                let opt = document.createElement('option');
                opt.value = b.code;
                opt.innerText = b.name;
                br.appendChild(opt);
            });

            d.categories.forEach(c => {
                let opt = document.createElement('option');
                opt.value = c.code;
                opt.innerText = c.name;
                // Auto-select "Superlibrarian" if found
                if(c.name.includes("Super") || c.code.includes("S")) opt.selected = true;
                cat.appendChild(opt);
            });
            alert(`Loaded ${d.branches.length} branches and ${d.categories.length} categories.`);
        });

        // 2. Create Superlibrarian
        function createSuper() {
            runTask('create_super', {
                inst: val('u_inst'),
                card: val('u_card'),
                user: val('u_name'),
                pass: val('u_pass'),
                branch: val('u_branch'),
                category: val('u_cat')
            });
        }

        // 3. Create MySQL User & Upload
        function createDBUser() {
            const fd = new FormData();
            fd.append('type', 'db_user');
            fd.append('dbname', val('db_name'));
            fd.append('host', val('db_host'));
            fd.append('dbuser', val('db_user'));
            fd.append('dbpass', val('db_pass'));
            
            // Optional File
            const f = document.getElementById('db_file');
            if(f.files.length > 0) fd.append('file', f.files[0]);

            const btn = document.querySelector('#users .btn-warn');
            const txt = btn.innerText;
            btn.innerText = "‚è≥ PROCESSING...";
            btn.disabled = true;

            fetch('/upload-sp', {method: 'POST', body: fd})
            .then(r => r.json())
            .then(d => {
                alert("Task Started. Check logs.");
                btn.innerText = txt;
                btn.disabled = false;
            })
            .catch(e => {
                alert("Error: " + e);
                btn.innerText = txt;
                btn.disabled = false;
            });
        }

        // --- DANGER ZONE ---
        
        function rmInstance() {
            const inst = val('rm_inst_name');
            if (!inst) { alert("Enter instance name!"); return; }
            if (confirm(`Are you sure you want to delete '${inst}'?\nThis cannot be undone.`)) {
                runTask('rm_inst', {inst: inst});
            }
        }

        function nukeStunnel() {
            if (confirm("Uninstall Stunnel completely?\nRemoves service, configs, and users.")) {
                runTask('rm_stunnel');
            }
        }

        function nukeTailscale() {
            if (confirm("NUKE TAILSCALE?\nYou will lose connection immediately.")) {
                runTask('rm_tailscale');
            }
        }

        function nukeKoha() {
            if (confirm("WARNING: UNINSTALL KOHA COMPLETELY?\nThis will remove ALL instances, databases, and users.")) {
                if (confirm("FINAL WARNING: This is irreversible.\nAre you really sure?")) {
                    runTask('rm_koha');
                }
            }
        }
    </script>
    <script src="/static/script.js"></script>
</body>
</html>
